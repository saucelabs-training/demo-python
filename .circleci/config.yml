version: 2
jobs:
  build_and_test:
    working_directory: ~/repo
    docker:
    - image: circleci/python:3.7.1
    steps:
    - checkout
    - run:
        name: Install pipenv
        command: |
          sudo pip install pipenv
          pipenv install
    - run:
        name: Install Requirements
        command: |
          sudo pip install -r requirements.txt
    - save_cache:
        key: deps9-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
        paths:
        - .venv
        - /usr/local/bin
        - /usr/local/lib/python3.6/site-packages
    - run:
        name: Install Sauce Connect Client
        command: |
          sudo apt-get install lsof
          curl https://saucelabs.com/downloads/sc-4.4.12-linux.tar.gz -o saucelabs.tar.gz
          tar -xzf saucelabs.tar.gz
    - run:
        name: Launch Tunnel 1
        background: true
        command: |
          cd sc-*
          bin/sc --pidfile /tmp/sc.pid1 -u ${SAUCE_USERNAME} -k ${SAUCE_ACCESS_KEY} -i demo-python-tunnel --no-remove-colliding-tunnels -B all --se-port 4445
    - run:
        name: Launch Tunnel 2
        background: true
        command: |
          cd sc-*
          bin/sc --pidfile /tmp/sc.pid2 -u ${SAUCE_USERNAME} -k ${SAUCE_ACCESS_KEY} -i demo-python-tunnel --no-remove-colliding-tunnels -B all --se-port 4446
    - run:
        name: Launch Tunnel 3
        background: true
        command: |
          cd sc-*
          bin/sc --pidfile /tmp/sc.pid3 -u ${SAUCE_USERNAME} -k ${SAUCE_ACCESS_KEY} -i demo-python-tunnel --no-remove-colliding-tunnels -B all --se-port 4447
    - run:
        name: Ignore SSL Errors
        command: |
          export PYTHONWARNINGS="ignore:Unverified HTTPS request"
    - run:
        name: Run PyTests
        command: |
          while ! lsof -i:4445 -t; do sleep 3; done
          while ! lsof -i:4446 -t; do sleep 3; done
          while ! lsof -i:4447 -t; do sleep 3; done
          pytest -rs  pytest/
    - run:
        name: Shut Down Sauce Connect Tunnel
        command: |-
          kill -9 `cat /tmp/sc.pid1`
          kill -9 `cat /tmp/sc.pid2`
          kill -9 `cat /tmp/sc.pid3`
workflows:
  version: 2
  workflow:
    jobs:
    - build_and_test